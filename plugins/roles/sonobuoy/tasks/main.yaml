---
- name: Generate sonobuoy plugins
  template:
    src: plugins/
    dest: "{{ work_dir }}/kubernetes/{{ inventory_name }}/sonobuoy/plugins/"

- name: Run sonobuoy
  command: |
    # run and waiting
    sonobuoy run --wait \
      {% if (plugins.systemd_logs.enabled) %}-p systemd-logs {% endif %}\
      {% if (plugins.e2e.enabled) %}-p e2e {% endif %}\
      {% if (plugins.e2e_ks.enabled) %}-p {{ work_dir }}/kubernetes/{{ inventory_name }}/sonobuoy/plugins/e2e-ks.yaml {% endif %}\
      {% if (plugins.kube_bench.enabled) %}-p {{ work_dir }}/kubernetes/{{ inventory_name }}/sonobuoy/plugins/kube-bench.yaml -p {{ work_dir }}/kubernetes/{{ inventory_name }}/sonobuoy/plugins/kube-bench-master.yaml {% endif %}\

- name: Retrieve result
  command: |
    cd {{ work_dir }}/kubernetes/{{ inventory_name }}/sonobuoy/ && sonobuoy retrieve

- name: Clean sonobuoy
  command: |
    sonobuoy delete 

